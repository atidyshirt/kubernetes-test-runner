version: v1beta11

deployments:
  - kubectl:
      kustomize: true
      manifests:
        - ./manifests/
    name: test-deployment

dev:
  terminal:
    command: ["node", "/opt/example-service/src/server.ts"]
    labelSelector:
      app: example-service
  sync:
  - labelSelector:
      app: example-service
    localSubPath: ./
    containerPath: /opt/example-service
    waitInitialSync: true
    excludePaths:
    - node_modules/
    - logs/
    onUpload:
      exec:
      - name: npm install
        command: |-
          npm install
          npm ci -y
        onChange: ["./package.json", "./package-lock.json"]
  - labelSelector:
      app: test-runner
    localSubPath: ./
    containerPath: /opt/test-runner
    waitInitialSync: true
    excludePaths:
    - node_modules/
    - logs/
    onUpload:
      exec:
      - name: npm install
        command: |-
          npm install
          npm ci -y
        onChange: ["./package.json", "./package-lock.json"]

commands:
- name: test
  command: devspace enter -l app=test-runner -- npm run test

# Watch mode has some complications, nodemon with --delay 1 works, so a single
# tick is enough to convince mocha that the files are there. Looking for a
# better solutoin to this...
# - name: watch
#   command: devspace enter -l app=test-runner -- npm run test:watch
